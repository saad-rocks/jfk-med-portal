const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-SvUTDYpM.js","assets/react-c0U51vzo.js","assets/firebase-Bz9ybdfi.js","assets/icons-C41eJsKq.js","assets/index-IxlbvR3_.css"])))=>i.map(i=>d[i]);
import{j as e,f as s,a as t,_ as a,u as r,d as n,e as l,n as i}from"./index-SvUTDYpM.js";import{r as d}from"./react-c0U51vzo.js";import{P as c}from"./PageHeader-yfs0G1du.js";import{C as o,b as m,a as u,c as x}from"./card-C7UMvtm_.js";import{B as h}from"./button-C_oKDOXG.js";import{B as g}from"./badge-mKe8BOon.js";import{I as j}from"./input-Cf836u6s.js";import{Z as f,C as p,Q as b,ae as N,a4 as v,S as y,n as w,ac as I,ab as k,u as E,D as S,O as C,o as D,af as A,f as M,a1 as $,b as L,c as F,F as U}from"./icons-C41eJsKq.js";import{g as R,d as z,e as B}from"./teacherAssignments-DCF62PJd.js";import{listEnrollments as T,debugDatabaseState as P,debugEnrollments as q,createSampleEnrollments as _,diagnoseEnrollmentData as O}from"./enrollments-3oX83C0U.js";import{q as V,d as H,w as Q,o as Y,e as G,T as W,u as J,f as Z,k as K,n as X}from"./firebase-Bz9ybdfi.js";import{l as ee}from"./courses-BxWJLNIE.js";import"./utils-CCUt_dAN.js";function se({selectedDate:s,onDateSelect:t,attendanceData:a={},attendanceStatusData:r={},showAttendanceStats:n=!1,minDate:l,maxDate:i}){const[c,u]=d.useState(new Date),x=e=>e.toISOString().split("T")[0],g=e=>{u(s=>{const t=new Date(s);return"prev"===e?t.setMonth(t.getMonth()-1):t.setMonth(t.getMonth()+1),t})},j=(e=>{const s=e.getFullYear(),t=e.getMonth(),a=new Date(s,t,1),r=new Date(s,t+1,0).getDate(),n=a.getDay(),l=[];for(let i=0;i<n;i++)l.push(null);for(let i=1;i<=r;i++)l.push(new Date(s,t,i));return l})(c);return e.jsx(o,{className:"w-full max-w-md shadow-lg border-0 bg-white",children:e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(h,{variant:"outline",size:"sm",onClick:()=>g("prev"),className:"h-9 w-9 p-0 hover:bg-gray-50 border-gray-200",children:e.jsx(f,{className:"h-4 w-4 text-gray-600"})}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{className:"h-5 w-5 text-blue-600"}),e.jsxs("span",{className:"font-semibold text-lg text-gray-800",children:[["January","February","March","April","May","June","July","August","September","October","November","December"][c.getMonth()]," ",c.getFullYear()]})]}),e.jsx(h,{variant:"outline",size:"sm",onClick:()=>g("next"),className:"h-9 w-9 p-0 hover:bg-gray-50 border-gray-200",children:e.jsx(b,{className:"h-4 w-4 text-gray-600"})})]}),e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx(h,{variant:"outline",size:"sm",onClick:()=>{u(new Date)},className:"text-sm",children:"Today"})}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-3",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(s=>e.jsx("div",{className:"text-center text-sm font-semibold text-gray-500 py-3 bg-gray-50 rounded-lg",children:s},s))}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:j.map((n,d)=>{if(!n)return e.jsx("div",{className:"aspect-square"},d);const c=(e=>{const s=x(e);return a[s]})(n),o=(e=>{const s=x(e);return r[s]})(n),m=(e=>!!(l&&e<l)||!!(i&&e>i))(n),u=(e=>!!s&&x(e)===x(s))(n),g=(e=>{const s=new Date;return x(e)===x(s)})(n),j=(()=>{if(u)return"bg-gradient-to-br from-blue-600 to-blue-700 text-white shadow-lg hover:from-blue-700 hover:to-blue-800";if(o)switch(o){case"present":return"bg-emerald-100 text-emerald-800 hover:bg-emerald-200 hover:scale-105 font-semibold border border-emerald-300 shadow-sm";case"absent":return"bg-red-100 text-red-800 hover:bg-red-200 hover:scale-105 font-semibold border border-red-300 shadow-sm";case"late":return"bg-amber-100 text-amber-800 hover:bg-amber-200 hover:scale-105 font-semibold border border-amber-300 shadow-sm";case"excused":return"bg-blue-100 text-blue-800 hover:bg-blue-200 hover:scale-105 font-semibold border border-blue-300 shadow-sm";default:return"text-gray-700"}return c?"bg-emerald-100 text-emerald-800 hover:bg-emerald-200 hover:scale-105 font-semibold border border-emerald-300 shadow-sm":"text-gray-700"})();return e.jsxs(h,{variant:u?"primary":"ghost",className:`\n                  aspect-square p-0 h-12 w-12 relative transition-all duration-200 !rounded-lg flex items-center justify-center\n                  ${g&&!u?"ring-2 ring-blue-400 ring-opacity-50 bg-blue-50":""}\n                  ${m?"opacity-40 cursor-not-allowed text-gray-400":"hover:bg-gray-100 hover:scale-105"}\n                  ${j}\n                `,onClick:()=>!m&&t(n),disabled:m,children:[e.jsx("span",{className:"text-sm font-medium relative z-0",children:n.getDate()}),c&&e.jsx("div",{className:"absolute -bottom-1 -right-1 w-4 h-4 bg-white rounded-full border border-gray-300 shadow-sm flex items-center justify-center",children:e.jsx("svg",{className:"w-2.5 h-2.5 text-emerald-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})]},d)})}),(n||Object.keys(a).length>0||Object.keys(r).length>0)&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsx("div",{className:"text-sm font-medium text-gray-700 mb-3",children:"Legend:"}),e.jsx("div",{className:"grid grid-cols-2 gap-3 text-xs",children:Object.keys(r).length>0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"h-6 w-6 bg-emerald-100 border border-emerald-300 rounded-lg flex items-center justify-center relative shadow-sm",children:[e.jsx("span",{className:"text-emerald-800 font-semibold text-xs",children:"15"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-white rounded-full border border-gray-300 shadow-sm flex items-center justify-center",children:e.jsx("svg",{className:"w-1.5 h-1.5 text-emerald-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})]}),e.jsx("span",{className:"text-gray-600",children:"Present"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 bg-red-100 border border-red-300 rounded-lg flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"text-red-800 font-semibold text-xs",children:"15"})}),e.jsx("span",{className:"text-gray-600",children:"Absent"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 bg-amber-100 border border-amber-300 rounded-lg flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"text-amber-800 font-semibold text-xs",children:"15"})}),e.jsx("span",{className:"text-gray-600",children:"Late"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-6 w-6 bg-blue-100 border border-blue-300 rounded-lg flex items-center justify-center shadow-sm",children:e.jsx("span",{className:"text-blue-800 font-semibold text-xs",children:"15"})}),e.jsx("span",{className:"text-gray-600",children:"Excused"})]})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"h-6 w-6 bg-emerald-100 border border-emerald-300 rounded-lg flex items-center justify-center relative shadow-sm",children:[e.jsx("span",{className:"text-emerald-800 font-semibold text-xs",children:"15"}),e.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 bg-white rounded-full border border-gray-300 shadow-sm flex items-center justify-center",children:e.jsx("svg",{className:"w-1.5 h-1.5 text-emerald-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:3,d:"M5 13l4 4L19 7"})})})]}),e.jsx("span",{className:"text-gray-600",children:"Attendance Marked"})]})})]})]})})}const te="attendance";async function ae(e,t){try{console.log("Querying attendance records for course:",e,"date:",t);const a=V(H(s,te),Q("courseId","==",e),Y("timestamp","desc")),r=await G(a);console.log("Query returned",r.size,"documents for course:",e);const n=[];return r.forEach(e=>{const s=e.data();s.date===t&&n.push({id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status,timestamp:s.timestamp instanceof W?s.timestamp.toMillis():s.timestamp,notes:s.notes,markedBy:s.markedBy})}),console.log("Found",n.length,"attendance records for",t),n}catch(a){return console.error("Error fetching attendance records for course date:",a),[]}}async function re(e,t){try{console.log("Getting attendance records for student:",e,"course:",t);const a=V(H(s,te),Q("studentId","==",e),Y("timestamp","desc")),r=await G(a);console.log("Query returned",r.size,"documents for student:",e);const n=[];return r.forEach(e=>{const s=e.data();s.courseId===t&&(console.log("Processing record for course:",{id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status}),n.push({id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status,timestamp:s.timestamp instanceof W?s.timestamp.toMillis():s.timestamp,notes:s.notes,markedBy:s.markedBy}))}),console.log("Filtered",n.length,"records for course",t),n}catch(a){return console.error("Error fetching student course attendance records:",a),[]}}async function ne(e,s){try{console.log("Getting attendance stats for course:",e,"date:",s);const t=await ae(e,s);console.log("Found",t.length,"attendance records for stats calculation");const a={total:t.length,present:t.filter(e=>"present"===e.status).length,absent:t.filter(e=>"absent"===e.status).length,late:t.filter(e=>"late"===e.status).length,excused:t.filter(e=>"excused"===e.status).length};return console.log("Calculated attendance stats:",a),a}catch(t){return console.error("Error getting course date attendance stats:",t),{total:0,present:0,absent:0,late:0,excused:0}}}async function le(e,s){try{const t=await re(e,s);if(0===t.length)return 100;const a=t.filter(e=>"present"===e.status||"late"===e.status).length;return Math.round(a/t.length*100)}catch(t){return console.error("Error calculating student course attendance percentage:",t),0}}async function ie(e){try{const t=await async function(e){try{const t=V(H(s,te),Q("courseId","==",e),Y("timestamp","desc")),a=await G(t),r=[];return a.forEach(e=>{const s=e.data();console.log("Processing record:",{id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status}),r.push({id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status,timestamp:s.timestamp instanceof W?s.timestamp.toMillis():s.timestamp,notes:s.notes,markedBy:s.markedBy})}),console.log("Returning",r.length,"attendance records"),r}catch(t){return console.error("Error fetching course attendance records:",t),[]}}(e),a={};return t.forEach(e=>{a[e.date]=!0}),a}catch(t){return console.error("Error getting course attendance dates:",t),{}}}async function de(e,s){try{const t=await re(e,s),a={};return t.forEach(e=>{a[e.date]=e.status}),a}catch(t){return console.error("Error getting student course attendance calendar:",t),{}}}function ce(e){const s=e.toISOString().split("T")[0];return console.log("Formatting date for storage:",e.toString(),"->",s),s}async function oe(e,t){try{const t=[],a=new Set,r=[],n=V(H(s,te),Q("courseId","==",e),Y("timestamp","desc")),l=await G(n);return l.forEach(e=>{const s=e.data();a.add(s.studentId),r.length<10&&r.push({id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status,timestamp:s.timestamp instanceof W?s.timestamp.toMillis():s.timestamp,notes:s.notes,markedBy:s.markedBy}),s.studentId&&""!==s.studentId.trim()||t.push(`Empty studentId in record ${e.id}`),s.date&&s.status||t.push(`Missing required fields in record ${e.id}`)}),{totalRecords:l.size,uniqueStudentIds:Array.from(a),sampleRecords:r,issues:t}}catch(a){return console.error("Error diagnosing attendance data:",a),{totalRecords:0,uniqueStudentIds:[],sampleRecords:[],issues:[`Diagnostic error: ${a instanceof Error?a.message:"Unknown error"}`]}}}function me(){const{role:b,user:Y}=r(),{push:me}=n(),[ue,xe]=d.useState(!0),[he,ge]=d.useState([]),[je,fe]=d.useState([]),[pe,be]=d.useState([]),[Ne,ve]=d.useState("course-selection"),[ye,we]=d.useState(null),[Ie,ke]=d.useState(new Date),[Ee,Se]=d.useState([]),[Ce,De]=d.useState([]),[Ae,Me]=d.useState([]),[$e,Le]=d.useState(""),[Fe,Ue]=d.useState({total:0,present:0,absent:0,late:0,excused:0}),[Re,ze]=d.useState({}),[Be,Te]=d.useState({}),[Pe,qe]=d.useState([]),[_e,Oe]=d.useState(0),[Ve,He]=d.useState({}),[Qe,Ye]=d.useState({}),[Ge,We]=d.useState(!1),[Je,Ze]=d.useState(!1),[Ke,Xe]=d.useState({}),[es,ss]=d.useState(null),[ts,as]=d.useState({attendance:null,enrollment:null,isRunning:!1}),[rs,ns]=d.useState({recordsToFix:[],incorrectIds:[],isRunning:!1,results:null});d.useEffect(()=>{ls()},[b,Y]);const ls=async()=>{try{if(xe(!0),"admin"===b||"teacher"===b){const[e,s]=await Promise.all([ee(),l()]);let t=[];if("teacher"===b&&Y){const e=s.find(e=>e.email?.toLowerCase()===Y.email?.toLowerCase()||e.uid===Y.uid);e?.id&&(t=await R(e.id))}ge(Array.isArray(t)?t:[]),fe(e),be(s.filter(e=>"student"===e.role))}else if("student"===b&&Y){console.log("Loading student data for user:",Y.uid);const[e,s,t]=await Promise.all([ee(),l(),T()]);fe(e),be(s.filter(e=>"student"===e.role));const a=s.find(e=>e.uid===Y.uid||e.email?.toLowerCase()===Y.email?.toLowerCase())??null,r=new Set;a?.id&&r.add(a.id),a?.uid&&r.add(a.uid),a?.studentId&&r.add(a.studentId),Y.uid&&r.add(Y.uid),Y.email&&r.add(Y.email.toLowerCase());const n=t.filter(e=>r.has(e.studentId));Me(n);const i=n[0]?.studentId??a?.id??a?.uid??Y.uid??null;ss(i),await is(i,n),ve("course-selection")}}catch(e){console.error("Error loading initial data:",e)}finally{xe(!1)}},is=async(e,s)=>{if(e&&0!==s.length)try{let e=0,t=0;await Promise.all(s.map(async s=>{if(!s.courseId)return;const a=await re(s.studentId,s.courseId);t+=a.length,e+=a.filter(e=>"present"===e.status||"late"===e.status).length}));const a=t>0?Math.round(e/t*100):100;Oe(a)}catch(t){console.error("Error calculating student attendance summary:",t),Oe(100)}else Oe(100)},ds=async e=>{we(e),ve("calendar-view");try{const s=(await T()).filter(s=>s.courseId===e.id),t=new Set(s.map(e=>e.studentId)),a=pe.filter(e=>!!(e.id||e.uid||e.email)&&(e.id&&t.has(e.id)||e.uid&&t.has(e.uid)||e.email&&t.has(e.email)));De(a);const r={};a.forEach(e=>{if(!e.id)return;const t=s.find(s=>s.studentId===e.id||s.studentId===e.uid||s.studentId===e.email);t&&(r[e.id]=t.studentId)}),Xe(s=>({...s,[e.id]:r}));const n=await ie(e.id);ze(n)}catch(s){console.error("Error loading course data:",s)}},cs=async e=>{if(!ye)return;ke(e),ve("take-attendance");const s=ce(e);try{const e=await ae(ye.id,s);Se(e),console.log("Loaded",e.length,"attendance records for date",s),await js();const t=await ne(ye.id,s);Ue(t),console.log("Calculated attendance stats for date",s,":",t)}catch(t){console.error("Error loading attendance data for date:",t)}},os=async(e,a)=>{if(ye?.id&&e){Ye(s=>({...s,[e]:!0}));try{const r=ce(Ie),n=Ce.find(s=>s.id===e);let l=Ke[ye.id]?.[e];if(l)console.log("- Using cached attendance studentId:",l);else{const s=await T(),t=s.filter(e=>e.courseId===ye.id).find(s=>s.studentId===e||n&&s.studentId===n.uid||n&&s.studentId===n.email);if(!t)throw new Error(`No enrollment found for student ${n?.name||"Unknown"}`);l=t.studentId,Xe(s=>({...s,[ye.id]:{...s[ye.id],[e]:l}}))}const i={id:`temp-${Date.now()}`,courseId:ye.id,studentId:e,date:r,status:a,timestamp:Date.now(),markedBy:"optimistic"};Te(s=>({...s,[e]:i})),await async function(e,a,r,n,l){try{if(!e)throw new Error("Course ID is required");if(!a)throw new Error("Student ID is required");if(!r)throw new Error("Date is required");if(!n)throw new Error("Attendance status is required");console.log("Creating attendance record:",{courseId:e,studentId:a,date:r,status:n,notes:l}),console.log("Date type:",typeof r,"Date value:",r);const i=(await ae(e,r)).find(e=>e.studentId===a);if(i){console.log("Updating existing attendance record");const e={status:n,timestamp:W.now(),markedBy:t.currentUser?.uid};return await J(Z(s,te,i.id),e),{...i,status:n,notes:l,timestamp:Date.now(),markedBy:t.currentUser?.uid}}const d={courseId:e,studentId:a,date:r,status:n,timestamp:W.now(),markedBy:t.currentUser?.uid};console.log("Creating new attendance record:",d);const c=await K(H(s,te),d);return console.log("Attendance record created successfully:",c.id),{id:c.id,courseId:e,studentId:a,date:r,status:n,timestamp:Date.now(),markedBy:t.currentUser?.uid,...void 0!==l?{notes:l}:{}}}catch(i){throw console.error("Error creating attendance record:",i),new Error(`Failed to create attendance record: ${i instanceof Error?i.message:"Unknown error"}`)}}(ye.id,l,r,a),ze(e=>({...e,[r]:!0}));const d=Ee.find(e=>e.studentId===l),c={...Fe};d?"present"===d.status?c.present--:"absent"===d.status?c.absent--:"late"===d.status?c.late--:"excused"===d.status&&c.excused--:c.total++,"present"===a?c.present++:"absent"===a?c.absent++:"late"===a?c.late++:"excused"===a&&c.excused++,Ue(c),me({title:"Attendance Marked",description:`${n?.name||"Student"} marked as ${a}`,variant:"success"})}catch(r){console.error("Error marking attendance:",r),Te(s=>({...s,[e]:Ee.find(s=>s.studentId===Ke[ye.id]?.[e])||null})),me({title:"Error",description:`Failed to mark attendance: ${r instanceof Error?r.message:"Unknown error"}`,variant:"error"})}finally{Ye(s=>({...s,[e]:!1}))}}},ms=async()=>{if(!ye?.id||0===Ce.length)return;We(!0);const e=ce(Ie);try{const{auth:t}=await a(async()=>{const{auth:e}=await import("./index-SvUTDYpM.js").then(e=>e.o);return{auth:e}},__vite__mapDeps([0,1,2,3,4]));if(!t.currentUser)throw new Error("User is not authenticated");const r=[];for(const e of Ce){if(!e.id)continue;let s=Ke[ye.id]?.[e.id];if(!s){const t=await T(),a=t.filter(e=>e.courseId===ye.id).find(s=>s.studentId===e.id||s.studentId===e.uid||s.studentId===e.email);a&&(s=a.studentId,Xe(t=>({...t,[ye.id]:{...t[ye.id],[e.id]:s}})))}s&&r.push({studentId:s,status:"present"})}if(0===r.length)throw new Error("No valid student enrollments found");const n=await async function(e,t,r){try{console.log("Starting bulk attendance update for",r.length,"students");const{auth:l}=await a(async()=>{const{auth:e}=await import("./index-SvUTDYpM.js").then(e=>e.o);return{auth:e}},__vite__mapDeps([0,1,2,3,4]));if(!l.currentUser)throw new Error("User must be authenticated");const i=X(s),d=W.now();let c=0,o=0;const m=[];for(const a of r)try{const{studentId:r,status:n}=a,o=(await ae(e,t)).find(e=>e.studentId===r);if(o){const e={status:n,timestamp:d,markedBy:l.currentUser.uid},t=Z(s,te,o.id);i.update(t,e)}else{const a=Z(H(s,te)),c={courseId:e,studentId:r,date:t,status:n,timestamp:d,markedBy:l.currentUser.uid};i.set(a,c)}c++}catch(n){o++,m.push(`Failed to update ${a.studentId}: ${n instanceof Error?n.message:"Unknown error"}`)}return c>0&&(await i.commit(),console.log(`Successfully updated ${c} attendance records`)),{success:c,failed:o,errors:m}}catch(n){return console.error("Error in bulk attendance update:",n),{success:0,failed:r.length,errors:[`Bulk operation failed: ${n instanceof Error?n.message:"Unknown error"}`]}}}(ye.id,e,r);n.failed>0?me({title:"Partial Success",description:`Marked ${n.success} students present, ${n.failed} failed`,variant:"default"}):me({title:"Bulk Attendance Marked",description:`Successfully marked ${n.success} students as present`,variant:"success"}),ze(s=>({...s,[e]:!0})),Ue(e=>({...e,total:Ce.length,present:n.success,absent:Ce.length-n.success,late:0,excused:0}));const l=await ae(ye.id,e);Se(l),await js()}catch(t){console.error("Error bulk marking attendance:",t),me({title:"Bulk Operation Failed",description:t instanceof Error?t.message:"Unknown error occurred",variant:"error"})}finally{We(!1)}},us=()=>{we(null),ve("course-selection"),Se([]),Ue({total:0,present:0,absent:0,late:0,excused:0}),ze({})},xs=async()=>{if(ye?.id)try{const e=await ie(ye.id);ze(e)}catch(e){console.error("Error reloading calendar data:",e)}ve("calendar-view"),Se([]),Ue({total:0,present:0,absent:0,late:0,excused:0})},hs=async()=>{if(ye?.id){as(e=>({...e,isRunning:!0}));try{console.log("🔍 Running attendance diagnostics for course:",ye.id);const[e,s]=await Promise.all([oe(ye.id),O(ye.id)]);as({attendance:e,enrollment:s,isRunning:!1}),console.log("📊 Diagnostic Results:"),console.log("Attendance Records:",e.totalRecords),console.log("Unique Student IDs in Attendance:",e.uniqueStudentIds),console.log("Enrollments:",s.totalEnrollments),console.log("Unique Student IDs in Enrollments:",s.uniqueStudentIds);const t=new Set(e.uniqueStudentIds),a=new Set(s.uniqueStudentIds),r=s.uniqueStudentIds.filter(e=>!t.has(e)),n=e.uniqueStudentIds.filter(e=>!a.has(e));r.length>0||n.length>0?(console.warn("⚠️ ID MISMATCH DETECTED!"),console.warn("Students enrolled but no attendance records:",r),console.warn("Attendance records for unenrolled students:",n),me({title:"ID Mismatch Detected",description:`${r.length} enrolled students missing attendance, ${n.length} extra records`,variant:"default"})):me({title:"Diagnostics Complete",description:"No ID mismatches found",variant:"success"})}catch(e){console.error("Error running diagnostics:",e),as(e=>({...e,isRunning:!1})),me({title:"Diagnostic Error",description:e instanceof Error?e.message:"Unknown error",variant:"error"})}}else me({title:"Error",description:"Please select a course first",variant:"error"})},gs=async()=>{if(ye?.id){ns(e=>({...e,isRunning:!0}));try{console.log("🔧 Analyzing attendance issues for course:",ye.id);const e=(await T()).filter(e=>e.courseId===ye.id),t=e.map(e=>e.studentId);console.log("Enrolled student IDs:",t);const r=await l(),n={};for(const s of e){const e=s.studentId,t=r.find(s=>s.uid===e||s.email===e||s.id===e||s.studentId===e);if(t){const s=[t.uid,t.email,t.id].filter(e=>e);if(!s.includes(e)){const a=s[0];a&&(n[e]=a,console.log(`Mapping ${e} -> ${a} (${t.name})`))}}}if(console.log("ID mapping to apply:",n),0===Object.keys(n).length)return me({title:"No Issues Found",description:"All attendance records appear to use correct student IDs",variant:"success"}),void ns(e=>({...e,isRunning:!1,recordsToFix:[],incorrectIds:[]}));const{recordsToFix:i,incorrectIds:d}=await async function(e,t){try{console.log("🔍 Finding attendance records that need fixing...");const a=[],r=new Set,n=V(H(s,te),Q("courseId","==",e));return(await G(n)).forEach(e=>{const s=e.data(),n=s.studentId;t.includes(n)||(r.add(n),a.push({id:e.id,courseId:s.courseId,studentId:s.studentId,date:s.date,status:s.status,timestamp:s.timestamp instanceof W?s.timestamp.toMillis():s.timestamp,notes:s.notes,markedBy:s.markedBy}))}),console.log("Found",a.length,"records needing fixes"),console.log("Incorrect student IDs:",Array.from(r)),{recordsToFix:a,incorrectIds:Array.from(r)}}catch(a){return console.error("Error getting records needing fix:",a),{recordsToFix:[],incorrectIds:[]}}}(ye.id,t);ns(e=>({...e,recordsToFix:i,incorrectIds:d,isRunning:!1})),console.log(`Found ${i.length} records needing fixes`),console.log("Incorrect IDs:",d),console.log("Applying automatic fix...");const c=await async function(e,t){try{console.log("🔧 Fixing attendance student IDs for course:",e),console.log("ID mapping:",t);const{auth:r}=await a(async()=>{const{auth:e}=await import("./index-SvUTDYpM.js").then(e=>e.o);return{auth:e}},__vite__mapDeps([0,1,2,3,4]));if(!r.currentUser)throw new Error("User must be authenticated");const n=X(s);let l=0,i=0;const d=[],c=V(H(s,te),Q("courseId","==",e)),o=await G(c);return console.log("Found",o.size,"attendance records to process"),o.forEach(e=>{const s=e.data().studentId;if(t[s]){const c=t[s];try{console.log(`Updating record ${e.id}: ${s} -> ${c}`),n.update(e.ref,{studentId:c,timestamp:W.now(),markedBy:r.currentUser?.uid}),l++}catch(a){i++,d.push(`Failed to update record ${e.id}: ${a instanceof Error?a.message:"Unknown error"}`)}}}),l>0&&(console.log(`Committing ${l} updates...`),await n.commit(),console.log("✅ Successfully updated",l,"attendance records")),{updated:l,failed:i,errors:d}}catch(r){return console.error("Error fixing attendance student IDs:",r),{updated:0,failed:1,errors:[`Fix operation failed: ${r instanceof Error?r.message:"Unknown error"}`]}}}(ye.id,n);ns(e=>({...e,results:c})),c.updated>0?(me({title:"Fix Applied Successfully",description:`Updated ${c.updated} attendance records`,variant:"success"}),await hs()):c.failed>0&&me({title:"Fix Failed",description:`Failed to update ${c.failed} records`,variant:"error"})}catch(e){console.error("Error analyzing/fixing attendance issues:",e),ns(e=>({...e,isRunning:!1})),me({title:"Fix Error",description:e instanceof Error?e.message:"Unknown error occurred",variant:"error"})}}else me({title:"Error",description:"Please select a course first",variant:"error"})},js=async()=>{if(!ye?.id)return;const e=(await T()).filter(e=>e.courseId===ye.id),s={};console.log("Building attendance mapping for",Ce.length,"students"),console.log("Course enrollments:",e.map(e=>({studentId:e.studentId}))),console.log("Attendance records:",Ee.map(e=>({studentId:e.studentId,status:e.status})));for(const t of Ce){if(!t.id)continue;console.log("Processing student:",{id:t.id,uid:t.uid,email:t.email,name:t.name});const a=e.find(e=>e.studentId===t.id||e.studentId===t.uid||e.studentId===t.email),r=a?.studentId||t.id;console.log("Enrollment found for student:",a),console.log("Using correctStudentId:",r);const n=Ee.find(e=>e.studentId===r);console.log("Found attendance record:",n),s[t.id]=n||null}Te(s),console.log("Final student attendance mapping:",s)},fs=async()=>{if(confirm("This will attempt to fix missing uid fields for existing users. Continue?"))try{await i(),alert("User uid fields have been updated. Please refresh the page to see the changes.");const e=await l();be(e.filter(e=>"student"===e.role))}catch(e){console.error("Error fixing user uids:",e),alert("Failed to fix user uids. Please check the console for details.")}},ps=s=>{switch(s){case"present":return e.jsx(D,{className:"h-4 w-4 text-green-600"});case"absent":return e.jsx(A,{className:"h-4 w-4 text-red-600"});case"late":return e.jsx(M,{className:"h-4 w-4 text-yellow-600"});case"excused":return e.jsx($,{className:"h-4 w-4 text-blue-600"});default:return null}},bs="admin"===b||"teacher"===b?"teacher"===b?he.map(e=>je.find(s=>s.id===e.courseId)).filter(Boolean).filter(e=>{if(!$e.trim())return!0;const s=$e.toLowerCase();return(e.title||"").toLowerCase().includes(s)||(e.code||"").toLowerCase().includes(s)}):je.filter(e=>{if(!$e.trim())return!0;const s=$e.toLowerCase();return(e.title||"").toLowerCase().includes(s)||(e.code||"").toLowerCase().includes(s)}):je.filter(e=>{if(!e.id)return!1;return Ae.some(s=>s.courseId===e.id)}).filter(e=>{if(!$e.trim())return!0;const s=$e.toLowerCase();return(e.title||"").toLowerCase().includes(s)||(e.code||"").toLowerCase().includes(s)});return ue?e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),e.jsx("span",{className:"text-gray-600",children:"Loading attendance system..."})]})}):"admin"===b||"teacher"===b?"calendar-view"===Ne&&ye?e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:`Attendance Calendar - ${ye.title}`,breadcrumb:[{label:"Attendance",to:"/attendance"},{label:ye.title}],actions:e.jsxs(h,{variant:"outline",onClick:us,children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Back to Courses"]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsx(x,{className:"text-lg",children:"Course Information"})}),e.jsxs(m,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Course Code"}),e.jsx("div",{className:"font-medium",children:ye.code})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Title"}),e.jsx("div",{className:"font-medium",children:ye.title})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Instructor"}),e.jsx("div",{className:"font-medium",children:ye.instructor})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Enrolled Students"}),e.jsx("div",{className:"font-medium",children:Ce.length})]}),Fe.total>0&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-700 mb-2",children:[Ie.toLocaleDateString()," Attendance:"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-green-100 border border-green-300 rounded"}),e.jsxs("span",{children:["Present: ",Fe.present]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-red-100 border border-red-300 rounded"}),e.jsxs("span",{children:["Absent: ",Fe.absent]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-100 border border-yellow-300 rounded"}),e.jsxs("span",{children:["Late: ",Fe.late]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-100 border border-blue-300 rounded"}),e.jsxs("span",{children:["Excused: ",Fe.excused]})]})]})]})]})]}),e.jsxs(o,{className:"lg:col-span-2",children:[e.jsxs(u,{children:[e.jsx(x,{className:"text-lg",children:"Select Date"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Click on a date to mark attendance for that day"})]}),e.jsx(m,{children:e.jsx(se,{selectedDate:Ie,onDateSelect:cs,attendanceData:Re,showAttendanceStats:!0})})]})]})]}):"take-attendance"===Ne&&ye?e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:`Mark Attendance - ${ye.title}`,breadcrumb:[{label:"Attendance",to:"/attendance"},{label:ye.title},{label:Ie.toLocaleDateString()}],actions:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:async()=>{Ze(!0);try{const e=ce(Ie),[s,t]=await Promise.all([ae(ye.id,e),ne(ye.id,e)]);Se(s),Ue(t),await js(),me({title:"Refreshed",description:"Attendance data updated",variant:"success"})}catch(e){console.error("Error refreshing attendance data:",e),me({title:"Refresh Failed",description:"Could not update attendance data",variant:"error"})}finally{Ze(!1)}},disabled:Je,className:"flex items-center gap-2",children:[Je?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(v,{className:"h-4 w-4"}),"Refresh"]}),e.jsxs(h,{onClick:hs,disabled:ts.isRunning,variant:"outline",size:"sm",className:"flex items-center gap-2",children:[ts.isRunning?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(y,{className:"h-4 w-4"}),"Diagnose"]}),e.jsxs(h,{variant:"outline",onClick:xs,children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Back to Calendar"]})]})}),ts.attendance&&ts.enrollment&&e.jsxs(o,{className:"mb-6",children:[e.jsx(u,{children:e.jsxs(x,{className:"flex items-center gap-2",children:[e.jsx(w,{className:"h-5 w-5 text-orange-600"}),"Attendance Diagnostic Results"]})}),e.jsxs(m,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Attendance Records"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:["Total Records: ",e.jsx("span",{className:"font-medium",children:ts.attendance.totalRecords})]}),e.jsxs("div",{children:["Unique Student IDs: ",e.jsx("span",{className:"font-medium",children:ts.attendance.uniqueStudentIds.length})]}),ts.attendance.issues.length>0&&e.jsxs("div",{className:"text-red-600",children:["Issues: ",ts.attendance.issues.length]})]}),ts.attendance.sampleRecords.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Sample Student IDs:"}),e.jsx("div",{className:"text-xs font-mono bg-gray-100 p-2 rounded max-h-20 overflow-y-auto",children:ts.attendance.sampleRecords.slice(0,5).map(e=>e.studentId).join(", ")})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Enrollments"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{children:["Total Enrollments: ",e.jsx("span",{className:"font-medium",children:ts.enrollment.totalEnrollments})]}),e.jsxs("div",{children:["Unique Student IDs: ",e.jsx("span",{className:"font-medium",children:ts.enrollment.uniqueStudentIds.length})]}),ts.enrollment.issues.length>0&&e.jsxs("div",{className:"text-red-600",children:["Issues: ",ts.enrollment.issues.length]})]}),ts.enrollment.sampleEnrollments.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Sample Student IDs:"}),e.jsx("div",{className:"text-xs font-mono bg-gray-100 p-2 rounded max-h-20 overflow-y-auto",children:ts.enrollment.sampleEnrollments.slice(0,5).map(e=>e.studentId).join(", ")})]})]})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsxs(h,{onClick:gs,disabled:rs.isRunning,variant:"outline",size:"sm",className:"flex items-center gap-2",children:[rs.isRunning?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(w,{className:"h-4 w-4"}),"Auto-Fix ID Issues"]}),rs.results&&e.jsxs("div",{className:"text-sm text-green-600 flex items-center",children:["✅ Fixed ",rs.results.updated," records"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsxs(x,{className:"text-lg flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5 text-blue-600"}),"Quick Actions"]})}),e.jsxs(m,{className:"space-y-3",children:[e.jsx(h,{onClick:ms,className:"w-full",variant:"outline",disabled:Ge,size:"sm",children:Ge?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"h-4 w-4 mr-2 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Mark All Present"]})}),e.jsxs(h,{onClick:async()=>{if(!ye?.id)return;const e=ce(Ie),s=await async function(e,s){try{const t=await ae(e,s);return{total:t.length,present:t.filter(e=>"present"===e.status).length,absent:t.filter(e=>"absent"===e.status).length,late:t.filter(e=>"late"===e.status).length,excused:t.filter(e=>"excused"===e.status).length,marked:t.length>0}}catch(t){return console.error("Error getting attendance summary:",t),{total:0,present:0,absent:0,late:0,excused:0,marked:!1}}}(ye.id,e);me({title:"Attendance Summary",description:`${s.present} present, ${s.absent} absent, ${s.late} late, ${s.excused} excused`,variant:"default"})},className:"w-full",variant:"ghost",size:"sm",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Get Summary"]}),e.jsxs(h,{onClick:async()=>{const e=ce(Ie),s=[["Student Name","Email","Status","Time"],...(await ae(ye.id,e)).map(e=>[Ce.find(s=>s.id===e.studentId)?.name||"Unknown",Ce.find(s=>s.id===e.studentId)?.email||"",e.status,new Date(e.timestamp).toLocaleString()])].map(e=>e.join(",")).join("\n"),t=new Blob([s],{type:"text/csv"}),a=URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.download=`attendance-${ye.title}-${e}.csv`,r.click(),URL.revokeObjectURL(a),me({title:"Export Complete",description:"Attendance data exported successfully",variant:"success"})},className:"w-full",variant:"ghost",size:"sm",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]})]}),e.jsxs(o,{children:[e.jsxs(u,{children:[e.jsxs(x,{className:"text-lg flex items-center gap-2",children:[e.jsx(E,{className:"h-5 w-5 text-green-600"}),"Daily Statistics"]}),e.jsx("p",{className:"text-sm text-gray-600",children:Ie.toLocaleDateString()})]}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"text-center p-3 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:Fe.total}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total"})]}),e.jsxs("div",{className:"text-center p-3 bg-green-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:Fe.present}),e.jsx("div",{className:"text-sm text-gray-600",children:"Present"})]}),e.jsxs("div",{className:"text-center p-3 bg-red-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:Fe.absent}),e.jsx("div",{className:"text-sm text-gray-600",children:"Absent"})]}),e.jsxs("div",{className:"text-center p-3 bg-yellow-50 rounded-lg",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:Fe.late}),e.jsx("div",{className:"text-sm text-gray-600",children:"Late"})]})]}),e.jsxs("div",{className:"text-center p-2 bg-blue-50 rounded-lg",children:[e.jsx("div",{className:"text-lg font-bold text-blue-600",children:Fe.excused}),e.jsx("div",{className:"text-sm text-gray-600",children:"Excused"})]})]})]}),e.jsxs(o,{className:"lg:col-span-2",children:[e.jsxs(u,{children:[e.jsx(x,{className:"text-lg",children:"Mark Attendance"}),e.jsx("div",{className:"flex gap-2",children:e.jsx(j,{placeholder:"Search students...",value:$e,onChange:e=>Le(e.target.value),className:"max-w-sm"})})]}),e.jsx(m,{children:e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:Ce.filter(e=>!$e.trim()||`${e.name} ${e.email}`.toLowerCase().includes($e.toLowerCase())).map(s=>{const t=s.id?Be[s.id]:null;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg transition-all duration-200 "+(Qe[s.id]?"bg-blue-50 border-blue-200":"hover:bg-gray-50"),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm font-medium text-gray-600",children:s.name.charAt(0).toUpperCase()})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-sm text-gray-600",children:s.email}),Qe[s.id]&&e.jsxs("div",{className:"text-xs text-blue-600 flex items-center gap-1 mt-1",children:[e.jsx(N,{className:"h-3 w-3 animate-spin"}),"Processing..."]})]})]}),e.jsx("div",{className:"flex gap-2",children:t?e.jsxs("div",{className:"flex items-center gap-2",children:[(a=t.status,e.jsxs(g,{variant:{present:"success",absent:"error",late:"secondary",excused:"outline"}[a],className:"capitalize",children:[ps(a),e.jsx("span",{className:"ml-1",children:a})]})),e.jsx(h,{size:"sm",variant:"ghost",onClick:()=>os(s.id,"present"),className:"text-gray-500 hover:text-gray-700",children:e.jsx(C,{className:"h-3 w-3"})})]}):e.jsxs("div",{className:"flex gap-1",children:[e.jsx(h,{size:"sm",variant:"outline",onClick:()=>os(s.id,"present"),className:"text-green-600 hover:text-green-700 hover:bg-green-50 border-green-200",disabled:Qe[s.id],title:"Mark Present",children:Qe[s.id]?e.jsx(N,{className:"h-3 w-3 animate-spin"}):e.jsx(D,{className:"h-3 w-3"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>os(s.id,"absent"),className:"text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200",disabled:Qe[s.id],title:"Mark Absent",children:Qe[s.id]?e.jsx(N,{className:"h-3 w-3 animate-spin"}):e.jsx(A,{className:"h-3 w-3"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>os(s.id,"late"),className:"text-yellow-600 hover:text-yellow-700 hover:bg-yellow-50 border-yellow-200",disabled:Qe[s.id],title:"Mark Late",children:Qe[s.id]?e.jsx(N,{className:"h-3 w-3 animate-spin"}):e.jsx(M,{className:"h-3 w-3"})}),e.jsx(h,{size:"sm",variant:"outline",onClick:()=>os(s.id,"excused"),className:"text-blue-600 hover:text-blue-700 hover:bg-blue-50 border-blue-200",disabled:Qe[s.id],title:"Mark Excused",children:Qe[s.id]?e.jsx(N,{className:"h-3 w-3 animate-spin"}):e.jsx($,{className:"h-3 w-3"})})]})})]},s.id);var a})})})]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:"Attendance Management",breadcrumb:[{label:"Home",to:"/"},{label:"Attendance"}]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:bs.length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Courses"})]}),e.jsx(L,{className:"h-8 w-8 text-blue-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:pe.length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Students"})]}),e.jsx(F,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:bs.filter(e=>"MD-1"===e?.semester).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Current Semester"})]}),e.jsx(M,{className:"h-8 w-8 text-yellow-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:bs.length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Total Courses"})]}),e.jsx(U,{className:"h-8 w-8 text-purple-600"})]})})})]}),e.jsxs(o,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{children:"teacher"===b?"My Courses":"All Courses"}),e.jsxs("div",{className:"flex gap-2",children:["admin"===b&&e.jsxs(e.Fragment,{children:[e.jsx(h,{variant:"outline",size:"sm",onClick:fs,className:"text-blue-600 border-blue-200 hover:bg-blue-50",children:"Fix User UIDs"}),e.jsx(h,{variant:"outline",size:"sm",onClick:async()=>{try{const e=await z();alert(`Found ${e.length} teacher assignments in database. Check console for details.`)}catch(e){console.error("Error fetching teacher assignments:",e),alert("Error fetching teacher assignments")}},className:"text-green-600 border-green-200 hover:bg-green-50",children:"Debug Assignments"}),e.jsx(h,{variant:"outline",size:"sm",onClick:async()=>{if(confirm("This will create sample teacher assignments for testing. Continue?"))try{await B(),alert("Sample teacher assignments created! Please refresh the page."),window.location.reload()}catch(e){console.error("Error creating sample assignments:",e),alert("Error creating sample assignments")}},className:"text-purple-600 border-purple-200 hover:bg-purple-50",children:"Create Sample Assignments"}),e.jsx(h,{variant:"outline",size:"sm",onClick:async()=>{try{await P(),alert("Database state checked. Check console for complete details.")}catch(e){console.error("Error checking database state:",e),alert("Error checking database state")}},className:"text-purple-600 border-purple-200 hover:bg-purple-50",children:"Debug Database"}),e.jsx(h,{variant:"outline",size:"sm",onClick:async()=>{try{const e=await q();alert(`Found ${e.length} enrollments in database. Check console for details.`)}catch(e){console.error("Error fetching enrollments:",e),alert("Error fetching enrollments")}},className:"text-blue-600 border-blue-200 hover:bg-blue-50",children:"Debug Enrollments"}),e.jsx(h,{variant:"outline",size:"sm",onClick:async()=>{if(confirm("This will create sample enrollments for testing. Continue?"))try{await _(),alert("Sample enrollments created! Please refresh the page."),window.location.reload()}catch(e){console.error("Error creating sample enrollments:",e),alert("Error creating sample enrollments")}},className:"text-orange-600 border-orange-200 hover:bg-orange-50",children:"Create Sample Enrollments"})]}),e.jsx(j,{placeholder:"Search courses...",value:$e,onChange:e=>Le(e.target.value),className:"max-w-sm"})]})]})}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-4",children:[bs.map(s=>s?e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(L,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.title}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.code," • ",s.semester]})]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-2",children:["Instructor: ",s.instructor]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>ds(s),children:[e.jsx(p,{className:"h-4 w-4 mr-2"}),"Mark Attendance"]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>ds(s),children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"View Records"]})]})]},s.id):null),0===bs.length&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(L,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No courses found"}),e.jsx("p",{className:"text-gray-600",children:"teacher"===b?"You haven't been assigned to teach any courses yet.":"No courses are available in the system."})]})]})})]})]}):"student"===b&&Y?"calendar-view"===Ne&&ye?e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:`My Attendance - ${ye.title}`,breadcrumb:[{label:"Attendance",to:"/attendance"},{label:ye.title}],actions:e.jsxs(h,{variant:"outline",onClick:us,children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Back to Courses"]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsx(x,{className:"text-lg",children:"Course Information"})}),e.jsxs(m,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Course Code"}),e.jsx("div",{className:"font-medium",children:ye.code})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Title"}),e.jsx("div",{className:"font-medium",children:ye.title})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Instructor"}),e.jsx("div",{className:"font-medium",children:ye.instructor})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"My Attendance"}),e.jsxs("div",{className:"font-medium text-blue-600",children:[_e,"%"]})]})]})]}),e.jsxs(o,{className:"lg:col-span-2",children:[e.jsxs(u,{children:[e.jsx(x,{className:"text-lg",children:"My Attendance Calendar"}),e.jsx("p",{className:"text-sm text-gray-600",children:"View your attendance record for this course"})]}),e.jsx(m,{children:e.jsx(se,{selectedDate:Ie,onDateSelect:()=>{},attendanceStatusData:Ve,showAttendanceStats:!0})})]})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:"My Attendance",breadcrumb:[{label:"Home",to:"/"},{label:"Attendance"}]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:bs.length}),e.jsx("div",{className:"text-sm text-gray-600",children:"My Courses"})]}),e.jsx(L,{className:"h-8 w-8 text-blue-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[_e,"%"]}),e.jsx("div",{className:"text-sm text-gray-600",children:"Overall Attendance"})]}),e.jsx(E,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:Pe.filter(e=>"present"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Present Days"})]}),e.jsx(D,{className:"h-8 w-8 text-green-600"})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold",children:Pe.filter(e=>"absent"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Absent Days"})]}),e.jsx(A,{className:"h-8 w-8 text-red-600"})]})})})]}),e.jsxs(o,{children:[e.jsx(u,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{children:"My Courses"}),e.jsx(j,{placeholder:"Search courses...",value:$e,onChange:e=>Le(e.target.value),className:"max-w-sm"})]})}),e.jsx(m,{children:e.jsxs("div",{className:"space-y-4",children:[bs.map(s=>{if(!s)return null;const t=Pe.filter(e=>e.courseId===s.id),a=t.length>0?Math.round(t.filter(e=>"present"===e.status||"late"===e.status).length/t.length*100):100;return e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx(L,{className:"h-5 w-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium",children:s.title}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.code," • ",s.semester]})]})]}),e.jsxs("div",{className:"text-sm text-gray-600 mt-2",children:["Instructor: ",s.instructor," • My Attendance: ",e.jsxs("span",{className:"font-medium "+(a>=75?"text-green-600":a>=60?"text-yellow-600":"text-red-600"),children:[a,"%"]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>ds(s),children:[e.jsx(p,{className:"h-4 w-4 mr-2"}),"View Calendar"]}),e.jsxs(h,{size:"sm",variant:"outline",onClick:()=>(async e=>{if(Y){we(e),ve("student-history");try{const s=Ae.find(s=>s.courseId===e.id),t=s?.studentId??es??Y.uid,[a,r,n]=await Promise.all([re(t,e.id),le(t,e.id),de(t,e.id)]);qe(a),Oe(r),He(n)}catch(s){console.error("Error loading student attendance history:",s)}}})(s),children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"View Details"]})]})]},s.id)}),0===bs.length&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx(L,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No courses found"}),e.jsx("p",{className:"text-gray-600",children:"You are not enrolled in any courses yet."})]})]})})]})]}):"student"===b&&Y&&"student-history"===Ne&&ye?e.jsxs("div",{className:"space-y-6",children:[e.jsx(c,{title:`Attendance Details - ${ye.title}`,breadcrumb:[{label:"Attendance",to:"/attendance"},{label:ye.title},{label:"Details"}],actions:e.jsxs(h,{variant:"outline",onClick:us,children:[e.jsx(f,{className:"h-4 w-4 mr-2"}),"Back to Courses"]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs(o,{children:[e.jsx(u,{children:e.jsx(x,{className:"text-lg",children:"Course Information"})}),e.jsxs(m,{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Course Code"}),e.jsx("div",{className:"font-medium",children:ye.code})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Title"}),e.jsx("div",{className:"font-medium",children:ye.title})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Instructor"}),e.jsx("div",{className:"font-medium",children:ye.instructor})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-600",children:"My Attendance"}),e.jsxs("div",{className:"font-medium text-blue-600",children:[_e,"%"]})]})]})]}),e.jsxs(o,{className:"lg:col-span-2",children:[e.jsx(u,{children:e.jsx(x,{className:"text-lg",children:"Attendance Summary"})}),e.jsxs(m,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:Pe.filter(e=>"present"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Present"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:Pe.filter(e=>"absent"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Absent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-yellow-600",children:Pe.filter(e=>"late"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Late"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:Pe.filter(e=>"excused"===e.status).length}),e.jsx("div",{className:"text-sm text-gray-600",children:"Excused"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Recent Attendance"}),e.jsx("div",{className:"space-y-1 max-h-64 overflow-y-auto",children:Pe.sort((e,s)=>new Date(s.date).getTime()-new Date(e.date).getTime()).slice(0,10).map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[e.jsx("div",{className:"text-sm",children:new Date(s.date).toLocaleDateString()}),e.jsx(g,{variant:"present"===s.status?"success":"absent"===s.status?"error":"late"===s.status?"secondary":"outline",className:"capitalize",children:s.status})]},t))}),0===Pe.length&&e.jsx("div",{className:"text-center py-4 text-gray-500",children:"No attendance records found for this course."})]})]})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx(c,{title:"Attendance",breadcrumb:[{label:"Home",to:"/"},{label:"Attendance"}]}),e.jsxs(o,{className:"p-8 text-center",children:[e.jsx($,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Access Denied"}),e.jsx("p",{className:"text-gray-600",children:"You don't have permission to access the attendance system."})]})]})}export{me as default};
