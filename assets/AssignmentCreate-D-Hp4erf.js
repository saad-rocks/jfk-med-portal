import{f as e,_ as s,u as t,j as a,e as l}from"./index-SvUTDYpM.js";import{r,u as i,l as c}from"./react-c0U51vzo.js";import{P as o}from"./PageHeader-yfs0G1du.js";import{u as n}from"./index.esm-C1BYIobo.js";import{d,e as m}from"./assignments-Dtn30G5f.js";import{d as x,g as h,b as u}from"./teacherAssignments-DCF62PJd.js";import{e as g,d as p,v as b,f,q as j,w as N}from"./firebase-Bz9ybdfi.js";import{B as w}from"./button-C_oKDOXG.js";import{I as v}from"./input-Cf836u6s.js";import{n as y,X as C,P as k,b as A,a4 as I,S as D,F as T,V as E,R as z,t as S}from"./icons-C41eJsKq.js";import"./utils-CCUt_dAN.js";class U{static async checkAllCollections(){console.log("🔍 Checking all Firestore collections...");const s=["users","courses","enrollments","teacherAssignments","assignments","submissions"];for(const a of s)try{const s=await g(p(e,a));console.log(`📊 ${a}: ${s.size} documents`)}catch(t){console.log(`❌ Error checking ${a}:`,t)}}static async checkUserDetails(s){console.log(`👤 Checking user details for: ${s}`);try{const t=await b(f(e,"users",s));if(t.exists()){const a=t.data();console.log("👤 User data:",a),console.log("📚 Checking enrollments for this user...");const l=j(p(e,"enrollments"),N("studentId","==",s)),r=await g(l);console.log(`📚 User enrollments: ${r.size}`),r.forEach(e=>{console.log("  - Enrollment:",e.data())}),console.log("👨‍🏫 Checking teacher assignments for this user...");const i=j(p(e,"teacherAssignments"),N("teacherId","==",s)),c=await g(i);console.log(`👨‍🏫 Teacher assignments: ${c.size}`),c.forEach(e=>{console.log("  - Assignment:",e.data())})}else console.log("❌ User not found")}catch(t){console.error("❌ Error checking user:",t)}}static async checkAllCourses(){console.log("📚 Checking all courses...");try{const s=await g(p(e,"courses"));console.log(`📚 Total courses: ${s.size}`),s.forEach(e=>{const s=e.data();console.log(`  - ${s.code}: ${s.title} (${s.semester})`)})}catch(s){console.error("❌ Error checking courses:",s)}}static async enrollUserInCourse(t,a){console.log(`📝 Enrolling user ${t} in course ${a}...`);try{const{addDoc:l}=await s(async()=>{const{addDoc:e}=await import("./firebase-Bz9ybdfi.js").then(e=>e.D);return{addDoc:e}},[]),r={studentId:t,courseId:a,status:"enrolled",enrolledAt:Date.now()},i=await l(p(e,"enrollments"),r);return console.log(`✅ User enrolled successfully with ID: ${i.id}`),i.id}catch(l){throw console.error("❌ Error enrolling user:",l),l}}static async assignTeacherToCourse(t,a,l){console.log(`👨‍🏫 Assigning teacher ${a} to course ${l}...`);try{const{addDoc:r,Timestamp:i}=await s(async()=>{const{addDoc:e,Timestamp:s}=await import("./firebase-Bz9ybdfi.js").then(e=>e.D);return{addDoc:e,Timestamp:s}},[]),c=await b(f(e,"courses",l));if(!c.exists())throw new Error(`Course ${l} not found`);const o=c.data(),n={teacherId:t,teacherEmail:a,courseId:l,courseCode:o.code,courseTitle:o.title,semester:o.semester||"Unknown",assignedAt:i.now(),status:"active"},d=await r(p(e,"teacherAssignments"),n);return console.log(`✅ Teacher assigned successfully with ID: ${d.id}`),d.id}catch(r){throw console.error("❌ Error assigning teacher:",r),r}}}const $=()=>U.checkAllCollections(),q=e=>U.checkUserDetails(e),F=()=>U.checkAllCourses(),P=(e,s)=>U.enrollUserInCourse(e,s),_=(e,s,t)=>U.assignTeacherToCourse(e,s,t);function M({courseId:s,onSuccess:i,onCancel:c}){const{user:o,role:U}=t(),[M,R]=r.useState(!1),[O,L]=r.useState(s||""),[V,W]=r.useState([]),[B,G]=r.useState([]),[H,Y]=r.useState(!1),[J,Q]=r.useState(null),{register:Z,handleSubmit:K,formState:{errors:X},watch:ee,setValue:se}=n({defaultValues:{type:"hw",weight:10,maxPoints:100}}),te=ee("type"),ae=B.find(e=>e.courseId===O),[le,re]=r.useState("per-assignment");r.useEffect(()=>{const t=s||O;t?(async()=>{try{const s=await b(f(e,"courses",t));if(s.exists()){const e=s.data();e.gradingMode&&re(e.gradingMode)}const a=await d(t);Q(a)}catch(s){console.error("Error loading weight usage:",s),Q(null)}})():Q(null)},[s,O]);const ie=async()=>{if(!s&&o&&"teacher"===U)try{console.log("🔍 Loading teacher courses for user:",o.uid,o.email,"Role:",U),await x();const s=await l();console.log("👥 All users loaded:",s.length,"users"),console.log("🔍 Looking for user with email:",o.email);const a=s.find(e=>e.email?.toLowerCase()===o.email?.toLowerCase());if(console.log("🎯 Current user found:",a),!a?.id)return console.error("❌ Teacher profile not found in database for email:",o.email),console.log("🔍 Available users:",s.map(e=>({id:e.id,email:e.email,role:e.role}))),G([]),void Y(!1);console.log("✅ Found teacher profile with ID:",a.id,"Role:",a.role),console.log("🔍 Calling getTeacherAssignments with ID:",a.id);const r=await h(a.id);console.log("📚 Teacher courses loaded:",r.length,"courses:",r),console.log("🔍 Trying checkTeacherAssignments with ID:",a.id);const i=await u(a.id);console.log("📚 Simple query results:",i.length,"courses:",i);const c=await x();console.log("🔍 All teacher assignments in collection:",c);const n=c.filter(e=>e.teacherId===a.id);console.log("🔍 Assignments matching current teacher ID:",n.length,n),c.length>0&&(console.log("🔍 Sample teacher assignment structure:",c[0]),console.log("🔍 All teacher IDs in collection:",c.map(e=>e.teacherId))),console.log("🔍 Checking if teacher is enrolled in any courses...");const d=j(p(e,"enrollments"),N("studentId","==",a.id),N("status","==","enrolled")),m=(await g(d)).docs.map(e=>({id:e.id,...e.data()}));console.log("📚 Teacher enrollments found:",m.length,m);let b=r;if(0===r.length&&i.length>0&&(console.log("🔄 Using simple query results as fallback..."),b=i),0===b.length&&m.length>0){console.log("🔄 No teacher assignments found, but teacher is enrolled in courses. Using enrolled courses as fallback...");const s=p(e,"courses"),l=[];for(const e of m)try{const t=await g(j(s,N("id","==",e.courseId)));if(!t.empty){const s=t.docs[0].data();l.push({id:t.docs[0].id,courseId:e.courseId,courseCode:s.code,courseTitle:s.title,semester:s.semester,teacherEmail:o.email,teacherId:a.id})}}catch(t){console.error("Error fetching course details:",t)}b=l,console.log("📚 Using enrolled courses as fallback:",b.length,b)}0===b.length&&(console.warn("⚠️ No courses found for teacher. This might indicate:"),console.warn("  - Teacher is not assigned to any courses in the teacherAssignments collection"),console.warn("  - teacherAssignments collection is empty"),console.warn("  - User ID mismatch:",a.id),console.warn("  - Check if teacher was properly assigned to courses via Manage Users"),console.warn("🔧 DEBUG: Run these commands in console to investigate:"),console.warn("   - checkDatabase() // See all collections"),console.warn("   - checkUser('"+a.id+"') // Check this specific user"),console.warn("   - checkCourses() // See all available courses"),console.warn("   - enrollUser('"+a.id+"', 'COURSE_ID') // Enroll in a course"),console.warn("   - assignTeacher('"+a.id+"', '"+o.email+"', 'COURSE_ID') // Assign as teacher"),"undefined"!=typeof window&&(window.checkDatabase=$,window.checkUser=q,window.checkCourses=F,window.enrollUser=P,window.assignTeacher=_)),G(b),Y(!1)}catch(t){console.error("❌ Error loading teacher courses:",t),Y(!1)}};if(r.useEffect(()=>{ie()},[s,o,U]),void 0!==U&&"teacher"!==U)return a.jsx("div",{className:"w-full max-w-4xl mx-auto",children:a.jsx("div",{className:"bg-white/95 rounded-3xl shadow-glow border border-slate-200/60",children:a.jsxs("div",{className:"p-6",children:[a.jsxs("div",{className:"flex items-center justify-between mb-6",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-critical-100/90 rounded-xl",children:a.jsx(y,{size:20,className:"text-critical-600"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"Access Denied"}),a.jsx("p",{className:"text-sm text-slate-600",children:"Only teachers can create assignments"})]})]}),a.jsx("button",{onClick:c,className:"p-2 hover:bg-slate-100/80 rounded-xl transition-colors",children:a.jsx(C,{size:20,className:"text-slate-500"})})]}),a.jsxs("div",{className:"bg-critical-50/90 border border-critical-200/60 rounded-2xl p-6 text-center",children:[a.jsxs("p",{className:"text-critical-700 mb-4",children:["Your current role is: ",a.jsx("strong",{className:"text-critical-800",children:U||"Not detected"})]}),a.jsx("p",{className:"text-critical-600 text-sm mb-6",children:"If you believe this is an error, please contact an administrator."}),a.jsx(w,{variant:"outline",onClick:c,className:"px-6",children:"Close"})]})]})})});if(void 0===U)return a.jsx("div",{className:"w-full max-w-4xl mx-auto",children:a.jsx("div",{className:"bg-white/95 rounded-3xl shadow-glow border border-slate-200/60",children:a.jsx("div",{className:"p-6",children:a.jsx("div",{className:"flex items-center justify-center py-16",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"w-8 h-8 border-2 border-medical-600 border-t-transparent rounded-full animate-spin"}),a.jsx("span",{className:"text-slate-600 text-lg",children:"Loading user permissions..."})]})})})})});const ce=[{value:"hw",label:"Homework",color:"bg-medical-100 text-medical-700 border-medical-200",icon:A},{value:"quiz",label:"Quiz",color:"bg-vital-100 text-vital-700 border-vital-200",icon:E},{value:"midterm",label:"Midterm",color:"bg-alert-100 text-alert-700 border-alert-200",icon:z},{value:"final",label:"Final",color:"bg-critical-100 text-critical-700 border-critical-200",icon:z}];return a.jsx("div",{className:"w-full max-w-4xl mx-auto",children:a.jsx("div",{className:"bg-white/95 rounded-3xl shadow-glow border border-slate-200/60",children:a.jsxs("div",{className:"p-6",children:[a.jsx("div",{className:"flex items-center justify-center mb-6",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-gradient-to-r from-medical-100 to-health-100 rounded-xl",children:a.jsx(k,{size:20,className:"text-medical-600"})}),a.jsxs("div",{children:[a.jsx("h2",{className:"text-xl font-bold text-slate-800",children:"Create New Assignment"}),a.jsx("p",{className:"text-sm text-slate-600",children:"Set up a new assignment for your students"})]})]})}),!s&&a.jsx("div",{className:"mb-6 p-4 bg-slate-50/90 border border-slate-200/60 rounded-2xl",children:a.jsxs("div",{className:"space-y-4",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Select Course *"}),B.length>0?a.jsxs("div",{className:"space-y-3",children:[a.jsxs("select",{value:O,onChange:e=>L(e.target.value),className:"w-full px-4 py-3 border-2 border-slate-200/60 rounded-xl focus:border-medical-400 focus:outline-none transition-all duration-200 text-slate-700 bg-white/90",required:!0,children:[a.jsx("option",{value:"",children:"Choose a course to create assignment for..."}),B.map(e=>a.jsxs("option",{value:e.courseId,children:[e.courseCode," - ",e.courseTitle]},e.courseId))]}),ae&&a.jsx("div",{className:"bg-medical-50/90 border border-medical-200/60 rounded-xl p-4",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx("div",{className:"p-2 bg-medical-100/80 rounded-lg",children:a.jsx(A,{size:20,className:"text-medical-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"font-semibold text-medical-800",children:ae.courseCode}),a.jsx("p",{className:"text-medical-700",children:ae.courseTitle}),a.jsxs("p",{className:"text-medical-600 text-sm",children:["Semester: ",ae.semester]})]})]})})]}):a.jsxs("div",{className:"bg-critical-50/90 border border-critical-200/60 rounded-2xl p-4",children:[a.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[a.jsx("div",{className:"p-2 bg-critical-100/80 rounded-lg",children:a.jsx(y,{size:20,className:"text-critical-600"})}),a.jsxs("div",{children:[a.jsx("p",{className:"text-critical-700 font-semibold",children:"No Courses Available"}),a.jsx("p",{className:"text-critical-600 text-sm",children:"You need to be assigned to courses before creating assignments"})]})]}),a.jsxs("div",{className:"space-y-3",children:[a.jsxs("div",{className:"bg-white/90 border border-critical-200/60 rounded-xl p-3",children:[a.jsxs("p",{className:"text-critical-800 text-sm font-medium mb-2",children:["🔧 ",a.jsx("strong",{children:"Solutions:"})]}),a.jsxs("div",{className:"text-critical-700 text-sm space-y-1",children:[a.jsxs("p",{children:["• Open browser console (F12) and run: ",a.jsx("code",{className:"bg-critical-100/60 px-2 py-1 rounded",children:"checkDatabase()"})]}),a.jsxs("p",{children:["• Check available courses: ",a.jsx("code",{className:"bg-critical-100/60 px-2 py-1 rounded",children:"checkCourses()"})]}),a.jsx("p",{children:"• Contact admin to assign you to courses via Manage Users"})]})]}),a.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[a.jsx(w,{type:"button",variant:"outline",onClick:()=>{Y(!0),ie()},disabled:H,className:"flex-1 sm:flex-none",children:H?a.jsxs(a.Fragment,{children:[a.jsx(I,{size:16,className:"mr-2 animate-spin"}),"Refreshing..."]}):a.jsxs(a.Fragment,{children:[a.jsx(I,{size:16,className:"mr-2"}),"Refresh"]})}),a.jsxs(w,{type:"button",variant:"outline",onClick:()=>{"undefined"!=typeof window&&(window.checkDatabase(),window.checkUser(o?.uid),window.checkCourses())},className:"flex-1 sm:flex-none",children:[a.jsx(D,{size:16,className:"mr-2"}),"Debug"]})]})]})]})]})}),a.jsxs("form",{onSubmit:K(async e=>{if(o){R(!0);try{const s={...e,courseId:O||e.courseId,dueAt:new Date(e.dueAt).getTime(),attachments:V.map(e=>e.name)};await m(s),i?.()}catch(s){console.error("Error creating assignment:",s)}finally{R(!1)}}}),className:"space-y-6",children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("h3",{className:"text-lg font-semibold text-slate-800 flex items-center gap-2",children:[a.jsx(T,{size:20,className:"text-medical-600"}),"Assignment Details"]}),a.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Assignment Title *"}),a.jsx(v,{...Z("title",{required:"Title is required"}),placeholder:"e.g., Chapter 5 Problem Set",className:"h-11 bg-white/90 "+(X.title?"border-critical-500 focus:border-critical-500":"")}),X.title&&a.jsx("p",{className:"text-critical-500 text-sm",children:X.title.message})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Assignment Type *"}),a.jsx("div",{className:"grid grid-cols-2 gap-2",children:ce.map(e=>{const s=e.icon;return a.jsxs("button",{type:"button",onClick:()=>se("type",e.value),className:"p-2 rounded-xl border-2 text-sm font-medium transition-all duration-200 flex items-center gap-2 justify-center "+(te===e.value?`${e.color} border-current shadow-md scale-105`:"border-slate-200/60 text-slate-700 hover:border-medical-300 hover:bg-medical-50/80 bg-white/80"),children:[a.jsx(s,{size:16}),e.label]},e.value)})})]})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Instructions *"}),a.jsx("textarea",{...Z("instructions",{required:"Instructions are required"}),placeholder:"Provide clear instructions for students on what to complete, how to submit, and any specific requirements...",rows:4,className:"w-full px-3 py-3 border-2 border-slate-200/60 rounded-xl focus:border-medical-400 focus:outline-none transition-colors resize-none bg-white/90 "+(X.instructions?"border-critical-500 focus:border-critical-500":"")}),X.instructions&&a.jsx("p",{className:"text-critical-500 text-sm",children:X.instructions.message})]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("h3",{className:"text-lg font-semibold text-slate-800 flex items-center gap-2",children:[a.jsx(z,{size:20,className:"text-alert-600"}),"Grading & Due Date"]}),a.jsxs("div",{className:"grid md:grid-cols-3 gap-4",children:[a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Due Date & Time *"}),a.jsx(v,{type:"datetime-local",...Z("dueAt",{required:"Due date is required"}),className:"h-11 bg-white/90 "+(X.dueAt?"border-critical-500 focus:border-critical-500":"")}),X.dueAt&&a.jsx("p",{className:"text-critical-500 text-sm",children:X.dueAt.message})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Max Points *"}),a.jsx(v,{type:"number",min:1,max:1e3,...Z("maxPoints",{required:"Max points is required",min:{value:1,message:"Must be at least 1 point"},max:{value:1e3,message:"Cannot exceed 1000 points"}}),placeholder:"100",className:"h-11 bg-white/90 "+(X.maxPoints?"border-critical-500 focus:border-critical-500":"")}),X.maxPoints&&a.jsx("p",{className:"text-critical-500 text-sm",children:X.maxPoints.message})]}),a.jsxs("div",{className:"space-y-2",children:[a.jsx("label",{className:"block text-sm font-semibold text-slate-700",children:"Weight (%) *"}),a.jsx(v,{type:"number",min:0,max:100,step:.1,disabled:"category"===le,...Z("weight",{required:"Weight is required",min:{value:0,message:"Weight must be positive"},max:{value:100,message:"Weight cannot exceed 100%"},validate:e=>{if("category"===le)return!0;if(!J)return!0;const s=J.remaining;return Number(e)<=s+1e-6||`Only ${s.toFixed(1)}% remaining in this course`}}),placeholder:"10",className:"h-11 bg-white/90 "+(X.weight?"border-critical-500 focus:border-critical-500":"")}),"category"===le&&a.jsx("p",{className:"text-xs text-slate-600",children:"Category-based grading is enabled for this course. Assignment weights are managed by category."}),J&&a.jsxs("p",{className:"text-xs text-slate-600",children:["Used: ",a.jsxs("span",{className:"font-medium",children:[J.total.toFixed(1),"%"]})," • Remaining: ",a.jsxs("span",{className:"font-medium",children:[J.remaining.toFixed(1),"%"]})," (target total: 100%)"]}),X.weight&&a.jsx("p",{className:"text-critical-500 text-sm",children:X.weight.message})]})]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("h3",{className:"text-lg font-semibold text-slate-800 flex items-center gap-2",children:[a.jsx(S,{size:20,className:"text-vital-600"}),"Supporting Materials (Optional)"]}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("input",{type:"file",multiple:!0,onChange:e=>{const s=Array.from(e.target.files||[]);W(e=>[...e,...s])},accept:".pdf,.doc,.docx,.txt,.jpg,.png,.zip,.rar",className:"hidden",id:"file-upload"}),a.jsxs("label",{htmlFor:"file-upload",className:"flex items-center gap-2 px-4 py-3 border-2 border-dashed border-slate-300/60 rounded-xl cursor-pointer hover:border-vital-400 hover:bg-vital-50/80 transition-all duration-200 bg-white/80",children:[a.jsx(S,{size:16,className:"text-vital-600"}),a.jsx("span",{className:"text-slate-700",children:"Choose files to attach"})]}),V.length>0&&a.jsx("div",{className:"space-y-2",children:V.map((e,s)=>a.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 bg-slate-50/90 rounded-xl border border-slate-200/60",children:[a.jsx("div",{className:"p-2 bg-vital-100/80 rounded-lg",children:a.jsx(T,{size:16,className:"text-vital-600"})}),a.jsxs("div",{className:"flex-1",children:[a.jsx("p",{className:"font-medium text-slate-800",children:e.name}),a.jsxs("p",{className:"text-sm text-slate-600",children:[(e.size/1024/1024).toFixed(2)," MB"]})]}),a.jsx(w,{type:"button",variant:"outline",size:"sm",onClick:()=>(e=>{W(s=>s.filter((s,t)=>t!==e))})(s),className:"text-critical-600 hover:text-critical-700 hover:bg-critical-50/80",children:a.jsx(C,{size:14})})]},s))})]})]}),a.jsxs("div",{className:"flex items-center justify-end gap-3 pt-4 border-t border-slate-200/60",children:[a.jsx(w,{type:"button",variant:"outline",onClick:c,disabled:M,className:"px-6",children:"Cancel"}),a.jsx(w,{type:"submit",disabled:M||!O&&!s,variant:"primary",className:"px-6",title:O||s?M?"Creating assignment...":"Create Assignment":"Please select a course first",children:M?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}),"Creating..."]}):a.jsxs(a.Fragment,{children:[a.jsx(k,{size:18,className:"mr-2"}),"Create Assignment"]})})]})]})]})})})}function R(){const e=i(),[s]=c(),t=s.get("courseId")||void 0;return a.jsxs("div",{className:"space-y-6",children:[a.jsx(o,{title:"Create Assignment"}),a.jsx(M,{courseId:t,onSuccess:()=>e("/assignments",{replace:!0}),onCancel:()=>e("/assignments",{replace:!0})})]})}export{R as default};
